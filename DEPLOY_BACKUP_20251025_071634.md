# ðŸš€ SkyBuild Pro - Deployment Instructions for Cursor/Claude Code

**Target**: Deploy to Ubuntu 22.04 LTS server
**Author**: Georgy Mikadze
**Date**: 2025-10-25

---

## ðŸ“‹ CONTEXT FOR CLAUDE CODE

Copy this entire section when starting a new session in Cursor:

```
You are helping deploy SkyBuild Pro, a multi-tenant construction estimation SaaS platform,
to a production Ubuntu server.

PROJECT CONTEXT:
- FastAPI backend with PostgreSQL database
- React + TypeScript frontend (2 apps: user-frontend, admin-frontend)
- Production-ready with all security fixes applied (13 P0, 4 P1 fixes)
- Multi-tenant isolation enforced
- Atomic billing system with credit refunds
- Email verification via SendGrid
- File processing (IFC, DWG, DXF, PDF)

SECURITY STATUS:
âœ… All P0 critical vulnerabilities fixed
âœ… Multi-tenant data isolation verified
âœ… Credits system atomic with refunds
âœ… Nginx security headers complete
âœ… Rate limiting configured
âœ… Email verification enforced

YOUR TASK:
Guide me through production deployment step-by-step. Be thorough, check for errors,
and ensure everything is properly configured before moving to next step.

IMPORTANT:
- Always verify commands executed successfully before proceeding
- Check logs for errors
- Confirm services are running before moving on
- Ask for confirmation before destructive operations
```

---

## ðŸŽ¯ PRE-DEPLOYMENT CHECKLIST

Before starting deployment, have these ready:

### 1. Server Access
- [ ] Ubuntu 22.04 LTS server with root/sudo access
- [ ] SSH access configured
- [ ] Firewall allows ports 80, 443, 22

### 2. Domain Configuration
- [ ] Domain names pointing to server IP:
  - `app.yourdomain.com` (user frontend)
  - `admin.yourdomain.com` (admin frontend)
- [ ] DNS A records configured (wait for propagation)

### 3. Credentials Prepared

**SendGrid (for emails):**
```bash
# Sign up at https://sendgrid.com
# Create API key with "Mail Send" permissions
# Verify sender email address
SENDGRID_API_KEY="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"
SENDGRID_FROM_EMAIL="noreply@yourdomain.com"
SENDGRID_FROM_NAME="SkyBuild Pro"
```

**Database:**
```bash
# Generate strong password
DB_PASSWORD=$(openssl rand -base64 32)
```

**Application Secret:**
```bash
# Generate SECRET_KEY (CRITICAL for security)
SECRET_KEY=$(openssl rand -hex 64)
```

**Admin User:**
- Email: `admin@yourdomain.com` (replace with real email)
- Password: Strong password (will use getpass during setup)

---

## ðŸ“¦ STEP 1: SERVER PREPARATION

SSH into your server and run initial setup:

```bash
# Update system
sudo apt update && sudo apt upgrade -y

# Install required packages
sudo apt install -y \
    python3.11 \
    python3.11-venv \
    python3-pip \
    postgresql \
    postgresql-contrib \
    nginx \
    git \
    curl \
    certbot \
    python3-certbot-nginx

# Install Node.js 20.x (for frontend build)
curl -fsSL https://deb.nodesource.com/setup_20.x | sudo -E bash -
sudo apt install -y nodejs

# Verify installations
python3.11 --version  # Should be 3.11.x
node --version        # Should be v20.x.x
npm --version
psql --version
nginx -v
```

**Tell Claude Code:**
```
I've completed server preparation. All packages installed successfully.
Please guide me to the next step.
```

---

## ðŸ“¦ STEP 2: DATABASE SETUP

Create PostgreSQL database and user:

```bash
# Switch to postgres user
sudo -u postgres psql

# In PostgreSQL prompt:
CREATE DATABASE skybuild_prod;
CREATE USER skybuild_user WITH ENCRYPTED PASSWORD 'YOUR_DB_PASSWORD_HERE';
GRANT ALL PRIVILEGES ON DATABASE skybuild_prod TO skybuild_user;
\q

# Test connection
psql -U skybuild_user -d skybuild_prod -h localhost -W
# Enter password when prompted
# If connected successfully: \q
```

**Tell Claude Code:**
```
Database created successfully. I can connect with skybuild_user.
Next step please.
```

---

## ðŸ“¦ STEP 3: CLONE REPOSITORY

```bash
# Create deployment directory
sudo mkdir -p /opt/skybuild
sudo chown -R $USER:$USER /opt/skybuild

# Clone repository
cd /opt
git clone https://github.com/baduk1/SkyBuild-Pro.git skybuild
cd skybuild

# Verify clone
ls -la
# Should see: apps/, backend/, deployment/, README.md, etc.
```

**Tell Claude Code:**
```
Repository cloned to /opt/skybuild. All files present.
What's next?
```

---

## ðŸ“¦ STEP 4: BACKEND SETUP

### 4.1 Create Virtual Environment

```bash
cd /opt/skybuild/backend

# Create venv
python3.11 -m venv venv

# Activate venv
source venv/bin/activate

# Upgrade pip
pip install --upgrade pip

# Install dependencies
pip install -r requirements.txt

# Verify installation
pip list | grep -E "fastapi|sqlalchemy|uvicorn"
```

### 4.2 Create .env File

```bash
# Create production environment file
nano /opt/skybuild/backend/.env
```

**Paste this (replace ALL CAPS values):**

```env
# Environment
ENV=production

# Database
DB_URL=postgresql://skybuild_user:YOUR_DB_PASSWORD@localhost:5432/skybuild_prod

# Security
SECRET_KEY=YOUR_64_CHAR_HEX_SECRET_HERE

# SMTP (SendGrid)
SMTP_HOST=smtp.sendgrid.net
SMTP_PORT=587
SMTP_USER=apikey
SMTP_PASSWORD=YOUR_SENDGRID_API_KEY
SMTP_FROM_EMAIL=noreply@yourdomain.com
SMTP_FROM_NAME=SkyBuild Pro

# Application
API_V1_PREFIX=/api/v1
BACKEND_CORS_ORIGINS=["https://app.yourdomain.com","https://admin.yourdomain.com"]

# File Storage
STORAGE_DIR=/opt/skybuild/backend/storage
MAX_UPLOAD_SIZE=52428800

# Features
ENABLE_PDF_PLAN_ENGINE=false

# Credits & Billing
COST_PER_JOB=200
STRIPE_API_KEY=sk_live_xxxxx
STRIPE_WEBHOOK_SECRET=whsec_xxxxx

# URLs (for emails)
USER_APP_ORIGIN=https://app.yourdomain.com
ADMIN_APP_ORIGIN=https://admin.yourdomain.com
```

**Save and exit** (Ctrl+X, Y, Enter)

### 4.3 Create Storage Directories

```bash
mkdir -p /opt/skybuild/backend/storage/{uploads,config,artifacts}
chmod 755 /opt/skybuild/backend/storage
```

### 4.4 Run Database Migrations

```bash
cd /opt/skybuild/backend

# Activate venv if not already
source venv/bin/activate

# Run migrations
python migrate_add_registration.py
python migrate_add_templates_estimates.py

# Verify tables created
psql -U skybuild_user -d skybuild_prod -h localhost -W -c "\dt"
# Should see: users, projects, jobs, files, suppliers, estimates, templates, etc.
```

### 4.5 Create Admin User

```bash
cd /opt/skybuild/backend
source venv/bin/activate

python create_admin_user.py
# Enter email: admin@yourdomain.com
# Enter password: [strong password - won't be echoed]
# Confirm password: [same password]
```

**Tell Claude Code:**
```
Backend setup complete. Database migrated, admin user created.
Storage directories configured. Ready for frontend setup.
```

---

## ðŸ“¦ STEP 5: FRONTEND BUILD

### 5.1 User Frontend

```bash
cd /opt/skybuild/apps/user-frontend

# Create .env for build
cat > .env << EOF
VITE_API_URL=https://app.yourdomain.com/api/v1
EOF

# Install dependencies
npm ci

# Build for production
npm run build

# Verify build
ls -lh dist/
# Should see: index.html, assets/, etc.
```

### 5.2 Admin Frontend

```bash
cd /opt/skybuild/apps/admin-frontend

# Create .env for build
cat > .env << EOF
VITE_API_URL=https://app.yourdomain.com/api/v1
EOF

# Install dependencies
npm ci

# Build for production
npm run build

# Verify build
ls -lh dist/
```

**Tell Claude Code:**
```
Both frontends built successfully. dist/ folders created.
Ready for Nginx configuration.
```

---

## ðŸ“¦ STEP 6: NGINX CONFIGURATION

### 6.1 Add Rate Limit Zone (CRITICAL)

```bash
# Edit main nginx config
sudo nano /etc/nginx/nginx.conf

# Find the http { } block and add INSIDE it:
# (Usually after 'include /etc/nginx/mime.types;')

limit_req_zone $binary_remote_addr zone=api_limit:10m rate=10r/s;

# Save and test
sudo nginx -t
```

### 6.2 Create Site Configuration

```bash
# Copy provided config
sudo cp /opt/skybuild/deployment/nginx.conf /etc/nginx/sites-available/skybuild

# Edit to replace yourdomain.com with actual domain
sudo nano /etc/nginx/sites-available/skybuild

# Replace ALL occurrences:
# - app.yourdomain.com â†’ your actual user domain
# - admin.yourdomain.com â†’ your actual admin domain
# - https://api.yourdomain.com â†’ your actual backend domain (in CSP header)

# Enable site
sudo ln -s /etc/nginx/sites-available/skybuild /etc/nginx/sites-enabled/

# Remove default site
sudo rm /etc/nginx/sites-enabled/default

# Test configuration
sudo nginx -t

# If OK, reload
sudo systemctl reload nginx
```

---

## ðŸ“¦ STEP 7: SSL CERTIFICATES

```bash
# Obtain certificates with certbot
sudo certbot --nginx \
  -d app.yourdomain.com \
  -d admin.yourdomain.com \
  --non-interactive \
  --agree-tos \
  -m admin@yourdomain.com \
  --redirect

# Verify certificates
sudo certbot certificates

# Test auto-renewal
sudo certbot renew --dry-run
```

**Tell Claude Code:**
```
SSL certificates installed successfully. HTTPS enabled.
Ready to start backend service.
```

---

## ðŸ“¦ STEP 8: SYSTEMD SERVICE

### 8.1 Create Service File

```bash
# Copy service file
sudo cp /opt/skybuild/deployment/skybuild-api.service /etc/systemd/system/

# Reload systemd
sudo systemctl daemon-reload

# Enable service (start on boot)
sudo systemctl enable skybuild-api

# Start service
sudo systemctl start skybuild-api

# Check status
sudo systemctl status skybuild-api

# View logs
sudo journalctl -u skybuild-api -f
# Press Ctrl+C to stop following logs
```

### 8.2 Verify Service is Running

```bash
# Check backend health
curl http://localhost:8000/api/v1/healthz
# Should return: {"ok":true}

# Check via domain
curl https://app.yourdomain.com/api/v1/healthz
# Should return: {"ok":true}
```

**Tell Claude Code:**
```
Backend service running successfully. Health check passing.
Ready for final verification.
```

---

## ðŸ“¦ STEP 9: FINAL VERIFICATION

### 9.1 Test User Frontend

```bash
# Open in browser
https://app.yourdomain.com

# Should see: Landing page with "Sign Up" button
# Check browser console for errors (F12)
```

### 9.2 Test User Registration

1. Click "Sign Up"
2. Enter email, password, confirm password
3. Click "Register"
4. Check email for verification link
5. Click verification link
6. Login with credentials
7. Should see Dashboard

### 9.3 Test Admin Panel

```bash
# Open in browser
https://admin.yourdomain.com

# Login with admin credentials created earlier
# Should see admin dashboard
```

### 9.4 Test File Upload

1. In user app, create a project
2. Upload an IFC file (test file in backend/tests/data/)
3. Create a job for the file
4. Watch SSE progress updates
5. Verify job completes
6. Check BOQ items generated

### 9.5 Check Logs

```bash
# Backend logs
sudo journalctl -u skybuild-api -n 100

# Nginx access logs
sudo tail -f /var/log/nginx/skybuild-user-access.log

# Nginx error logs
sudo tail -f /var/log/nginx/skybuild-user-error.log
```

**Tell Claude Code:**
```
All verification tests passed. Application is running in production.
What are the next steps for monitoring and maintenance?
```

---

## ðŸ“¦ STEP 10: POST-DEPLOYMENT

### 10.1 Setup Backups

```bash
# Create backup script
sudo nano /opt/skybuild/backup.sh
```

**Paste:**

```bash
#!/bin/bash
BACKUP_DIR="/opt/skybuild/backups"
TIMESTAMP=$(date +%Y%m%d_%H%M%S)
mkdir -p $BACKUP_DIR

# Backup database
pg_dump -h localhost -U skybuild_user skybuild_prod | gzip > $BACKUP_DIR/db_$TIMESTAMP.sql.gz

# Backup storage
tar -czf $BACKUP_DIR/storage_$TIMESTAMP.tar.gz /opt/skybuild/backend/storage

# Keep only last 7 days
find $BACKUP_DIR -type f -mtime +7 -delete

echo "Backup completed: $TIMESTAMP"
```

```bash
# Make executable
chmod +x /opt/skybuild/backup.sh

# Add to crontab (daily at 2 AM)
(crontab -l 2>/dev/null; echo "0 2 * * * /opt/skybuild/backup.sh") | crontab -
```

### 10.2 Setup Monitoring

```bash
# Install htop for resource monitoring
sudo apt install -y htop

# Check resource usage
htop

# Monitor backend process
ps aux | grep uvicorn
```

---

## ðŸ”§ TROUBLESHOOTING GUIDE

### Backend won't start

```bash
# Check logs
sudo journalctl -u skybuild-api -n 50

# Common issues:
# 1. SECRET_KEY not set â†’ Check .env file
# 2. Database connection failed â†’ Check DB_URL and PostgreSQL status
# 3. SMTP invalid â†’ Check SendGrid credentials

# Restart service
sudo systemctl restart skybuild-api
```

### Emails not sending

```bash
# Check SMTP settings
grep SMTP /opt/skybuild/backend/.env

# Test SendGrid connection
curl -I https://smtp.sendgrid.net:587

# View email logs
sudo journalctl -u skybuild-api | grep -i email
```

### Nginx errors

```bash
# Check config syntax
sudo nginx -t

# View error logs
sudo tail -f /var/log/nginx/error.log

# Restart Nginx
sudo systemctl restart nginx
```

### Database connection errors

```bash
# Check PostgreSQL status
sudo systemctl status postgresql

# Test connection
psql -U skybuild_user -d skybuild_prod -h localhost

# Check .env DB_URL
grep DB_URL /opt/skybuild/backend/.env
```

---

## ðŸŽ¯ SUCCESS CRITERIA

Your deployment is successful when:

- [ ] User frontend loads at https://app.yourdomain.com
- [ ] Admin frontend loads at https://admin.yourdomain.com
- [ ] User can register and receive verification email
- [ ] User can verify email and login
- [ ] User can create projects
- [ ] User can upload files
- [ ] Jobs process successfully with SSE updates
- [ ] BOQ items are generated
- [ ] Admin can login to admin panel
- [ ] SSL certificates are valid (green lock in browser)
- [ ] Health check returns {"ok":true}
- [ ] No errors in browser console
- [ ] No errors in backend logs
- [ ] All services start on server reboot

---

## ðŸ“ž SUPPORT

If you encounter issues:

1. Check logs: `sudo journalctl -u skybuild-api -f`
2. Check Nginx logs: `sudo tail -f /var/log/nginx/error.log`
3. Verify .env file has correct values
4. Ensure all services are running: `systemctl status skybuild-api nginx postgresql`

---

**Deployment Complete! ðŸŽ‰**

Author: Georgy Mikadze
